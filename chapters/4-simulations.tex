% !TEX root = ../thesis_main.tex
\section{Simulation methods}\label{chapter:simulations}
\subsection{Biot Savart field simulations}
\subsubsection{$B_0$ fields in low field NMR}\label{simulations:B$_0$}
\label{sec:simulations:B0sim}
        For $B_0$ field generation, mostly solenoid coils with compensation windings on both ends were used. To find optimal lengths and numbers of layers, Matlab simulations of static fields using Biot Savart's law were employed:
        \begin{equation}
            B(\vec r) = \frac{\mu_0}{4\pi} \int_V I\mathrm{d} \vec l \times \frac{\vec r - \vec r^{'}}{\left|\vec r - \vec r^{'}\right|^3}
        \end{equation}
        To calculate the fields, the coils were split into 30 parts per turn and each part was considered a straight, short enough path for numerical integration. Two entangled loops were used to step through the windings and winding parts while the actual Biot Savart calculation for each part was performed in  3D-matrix notation for the volume of interest. This sped up the calculations compared to looping over both positions and coil elements. Additionally, a parallel pool was added to reduce calculation time for the inner loop over the winding parts.
        All dimensions can be modified arbitrarily, but one has to keep in mind that results close to the coil elements will not be of real physical meaning. Nevertheless, they usually indicate well where in the graph coil elements are situated.  Both solenoidal "corkscrew" structures and closed loops were implemented and can be switched through a boolean. The measure considered for field homogeneity simulations was absolute field distribution inside a volume of $(\SI{3}{\centi\meter})^3$. Fields were calculated in a grid of $(30)^3$ points. Absolute field difference inside the volume was considered first to find the approximate range in which homogeneity is high. It was then refined by a histogram evaluation which yields results similar to the Lorentzian distribution a Fourier transformed NMR signal shows. To estimate linewidths generated by field inhomogeneities, a conservative measure of the central 80 \% of field points (i.e. the central 80 \% of bins) was used to estimate the homogeneity inside the region of interest.  Using this representation and varying different parameters such as diameter, distances and relative currents in different loop structures, optimal geometries for different coil designs were calculated. For Matlab code, see \url{https://github.com/elphil/solenoidSimulation/tree/master/src}
        \subsubsection{Solenoid Coil}
        The field of an infinitely long solenoid would be almost perfectly homogeneous on and along its symmetry axis. Due to the limited length of the actual coil, even on the symmetry axis, the field diverges toward the ends of the coil. Coils of finite length have been simulated using different numbers of layers and different geometric parameters. Parameter were varied in the ranges shown in table \ref{table:simulations:solenoidParameters}
        \begin{table} 
            \label{table:simulations:solenoidParameters}
            \centering
            \begin{tabular}{|c|c|c|c|}
                \hline
                length / mm & radius / mm & wire thickness / mm & number of layers \\
                250 - 300 & 50 - 70 & 0.1 - 1.5 & 1 - 3\\
                \hline
            \end{tabular}
        \end{table}
        For a schematic drawing of the coil (including compensation windings described in the next section) see chapter \ref{fig:matMeth:b0CoilSolenoid}.

        \subsubsection{Additional Compensation Windings}
        Additional compensation windings further smoothed the field by adding a differently shaped field component that can be used to partly compensate the solenoids inhomogeneities. See figure \ref{fig:results:solenoidField} in the results shows the fields of solenoid and compensation windings in the x-z-plane and the resulting superposition.
        To evaluate the field in the 3D sample volume, histograms of the field distribution were generated for different compensation wind lengths. They were used as a conservative measure of field homogeneity displaying the maximum and minimum magnetic field in the sample volume.
        \subsubsection{Dual Helmholtz Array}\label{simulations:DualHelmholtzArray}
        As a more advanced setup that is less prone to manufacturing errors due to the relatively larger distances to the sample volume, less error propagation during winding and a more flexible design, a dual Helmholtz array design was considered. A single Helmholtz array provides less homogeneity than a solenoid \cite{bienkowski_techniczne_2015}, but the additional pair of coils generates a differently shaped field similar to the compensation windings for the solenoid. By variation of the distances of both pairs relative to the center and their respective field strengths, i.e. the currents of the coil pairs, optimal parameters were extracted from the simulations. As the maximum and minimum radii were given by the space between mu metal shield and the shimming tube between which the B$_0$ coil should be positioned, the variation in radius was not considered. Instead, coils were predetermined to be of inner radius \SI{65}{\mm} with twelve layers width and eight layers height per coil element.
        Additionally, absolute fields values were calculated to estimate the currents necessary for $^{1}$H Sabre (i.e. to generate \SI{5}{\milli\tesla} roughly).
    \subsection{LTSpice electronics simulations}
        For designing coils and resonant circuits, simulations of the circuits makes sense to double check circuits for design errors or flaws. In cases of single resonant coils, this was not necessary due to their low complexity, but for the design of dual resonant coils, this is already useful. Electric elements can be described very details in this software as blind inductances and capacitances can be added to the parts as well as ohmic resistances for parts that ideally would be of solely complex impedance, i.e. even complex equivalent circuits can be added as one part.
        A design is first drawn, values are then added on a part by part basis and the program can then run different analyses of the circuit. This includes AC analyses as well as DC calculations. Different step sizes can be used and different frequencies can be sampled. The flexibility is high as the input - while featuring a GUI - is actually pseudo-command line based. Circuits such as the first Arduino shield for the fluxgate were simulated to ensure proper readout of voltages. For the dual resonant, single channel circuits, different designs have been tested to find optimally performing compositions.
    \subsection{Autodesk Inventor simulations}
    The simulation toolbox of Autodesk Inventor was used to check pressure resistances of designed parts before manufacture. The program is easy to use - definitions of the materials used and the volume encased were necessary, the former is given in table \ref{table:sim:PSU} for PSU and PVC, the two materials mainly used in this work and was taken from \cite{noauthor_basf_nodate}. The parameters lower bounds were entered for all strengths to ensure that in worst case scenarios, the parts would still hold up to the stress. With the parameters entered and a closed surface defined, Autodesk uses a finite elements method to calculate the strain on the components. Display of the results is in color, but actual deformation is displayed strongly exaggerated for better visualization of the deformation that is usually small compared to the dimensions of the parts. Simulations were performed at pressures of \SI{200}{\bar} to ensure at \SI{50}{\bar}, where the maximum system pressure was supposed to be, a safety factor of 4 would be kept.
        \begin{table}
            \label{table:sim:PSU}
            \centering
            \begin{tabular}{|r|c|c|}
                \hline
                parameter & unit & value\\
                \hline
                thermal conductivity & $\frac{\si{\watt}}{\si{\meter} \si{\kelvin}}$ & 0.211 \\
                specific heat & $\frac{J}{g\cdot K }$ & 2.859\\
                thermal expansion coefficient & $\frac{\si{\micro\meter}}{\si{\m}\si{\kelvin}}$ & 150 \\
                Young's modulus & MPa & 911\\
                Poisson's ratio && 0.93\\
                tensile strength & MPa & 13.78\\
                yield strength & MPa & 20.67\\
                density &$(\si{\g}/\si{\cm\cubed}$) & 1.24 \\
                \hline
            \end{tabular}
            \caption[PSU properties]{The properties of PSU as used in the strain simulations in Autodesk Inventor.}
        \end{table}
    \subsection{Simulations using the group's spin dynamics framework}
To estimate the field and contact times necessary for the Sabre experiments with nicotinamide, calculations previously done in this group for pyridine \cite{knecht_spin_2014} were repeated for nicotinamide. The coupling of the sample molecule to the pH$_2$ via the catalyst was kept \cite{green_theory_2012-1} while the chemical shifts inside the molecule and thus the coupling between the internal spins were changed. Parameters are listed in table \ref{table:simulations:spinFrameworkParameters}. Indices concern the 
        \begin{table}
        \centering
            \begin{tabular}{|c|c|}
                \hline
                parameter & value\\
                \hline
                chemical shifts & \\
                \hline
                $\delta_1$ & \SI{-22}{\hertz}\\
                $\delta_2$ & \SI{8.9}{\hertz}\\
                \hline
                J- couplings & \\
                \hline
                $J_{12}$ & \SI{7}{\hertz}\\
                $J_{13}$ & \SI{3}{\hertz}\\
                $J_{14}$ & \SI{0.1}{\hertz}\\
                $J_{23}$ & \SI{0.1}{\hertz}\\
                $J_{24}$ & \SI{0}{\hertz}\\
                $J_{34}$ & \SI{7}{\hertz}\\
                \hline
            \end{tabular}
            \caption[Spin framework parameters]{Parameters used in the spin framework simulations. Couplings between pH$_2$ and catalyst from \ref{duckett paper}. }
            \label{table:simulations:spinFrameworkParameters}
        \end{table}
